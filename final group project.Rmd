---
title: "Final project"
output: html_document
---

```{r setup, include=FALSE}
library(googlesheets4)
library(tidyverse)
library(janitor) 
library(skimr)
library(countrycode) # to clean up country names
library(broom)
library(car)
library(ggfortify)
```

```{r}
# use googlesheets4 to get data

# bhjcfbdhferbvjrejrejruefbhje
url <- "https://docs.google.com/spreadsheets/d/1IPS5dBSGtwYVbjsfbaMCYIWnOuRmJcbequohNxCyGVw/edit?resourcekey#gid=1625408792"
googlesheets4::gs4_auth() # google sheets authorisation

# load "Ask a A Manager 2021 Survey" googlesheet
# https://www.askamanager.org/
ask_a_manager_2021 <- googlesheets4::read_sheet(url) %>% 
  janitor::clean_names()

# if googlesheets is now working, read local copy
# ask_a_manager_2021 <- read_csv(here::here("data", "ask_a_manager_2021.csv"))


skimr::skim(ask_a_manager_2021)

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


```{r cars}
clean_data1 <- ask_a_manager_2021%>%
  drop_na(industry)%>%
select(-"additional_context_on_job_title") %>% 
select(-"additional_context_on_income")%>%
select(-"currency_other")%>%
select(-"state")%>%
select(-"city")

clean_data1$other_monetary_comp[is.na(clean_data1$other_monetary_comp)]= 0 
clean_data2 <- clean_data1 %>% 
  mutate(other_monetary_comp = as.numeric(replace(other_monetary_comp, which(other_monetary_comp == "NULL"), 0)))
clean_data3 <- clean_data2 %>% 
  mutate(total_salary = other_monetary_comp + annual_salary)

# exchange different currency to new column, named USD_exchange
## write a function to convert currency 
 currencyCon <- function(x,from = "USD", to = "EUR"){
   values<-c(1.00,0.92,0.81,1.27)
   names(values)<-c("USD","EUR","GBP","CAD")
   values[to]/(values[from]/x)
 }

## apply the function and create a new column
clean_data4 <- clean_data3 %>% 
  mutate(USD_exchange = currencyCon(clean_data3$total_salary, clean_data3$currency, "USD"))

clean_data5 <- clean_data4 %>% 
  mutate(country=countryname(country,'iso3c'))%>%
  drop_na(country)

```


```{r pressure, echo=FALSE}
clean_data <- clean_data5 %>% 
  filter(gender!="Non-binary")%>%
 filter(gender!="Other or prefer not to answer")%>%
  filter(gender!="Prefer not to answer")
  
mean_clean <- clean_data %>% 
  group_by(gender, industry)%>%
  summarise(mean1=mean(USD_exchange))

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r ppp data}
ppp_data1 <- read_csv(here::here("data","pppdata.csv"))

ppp_data2 <- ppp_data1 %>% 
  filter(TIME == "2020") 

ppp_data3<-ppp_data2[!(ppp_data2$LOCATION=="EU27_2020" | ppp_data2$LOCATION=="EA19"),]
 
```

```{r left join}
ppp_data4 <- ppp_data3 %>% select(LOCATION, Value)
merge_data <- left_join(clean_data, ppp_data4, by = c('country' = 'LOCATION'))
ppp_data<- merge_data %>% mutate(ppp_salary = total_salary / Value) %>% filter(!is.na(Value))

ppp_data %>%
  drop_na(industry) %>%
  group_by(industry) %>%
  summarise(Freq = n()) %>%
  ggplot(aes(x=fct_reorder(industry, Freq), y=Freq)) +
  geom_bar(stat = "identity", fill = "cornflowerblue") +
  geom_text(aes(label = Freq), position = position_dodge(width = 1), hjust = -0.2, size = 2) +
  coord_flip() +
  ylim(0, 3500) +
  xlab("Industry") +
  ylab("Responses") +
  ggtitle("Responses by Industry") +
  theme_bw()
```


```{r}
model1 <- lm(ppp_salary ~ job_title + overall_years_of_professional_experience, data=ppp_data)
model2 <- lm(ppp_salary ~ job_title + overall_years_of_professional_experience + years_of_experience_in_field , data=ppp_data)

# model3 <- lm(ppp_salary ~ years_bank*gender, data=bank_salaries)


mosaic::msummary(model1)
mosaic::msummary(model2)
```

```{r}
library(stringr)

filter(ppp_data, str_detect(industry, "^Aca"))

ppp_data5 <- ppp_data %>%
  mutate(
    industry_filtered = case_when(
     str_detect(ppp_data$industry, "^Aca*") ~ "Academia")
  )

```

