---
title: "Final project"
output: html_document
---

```{r setup, include=FALSE}
library(googlesheets4)
library(tidyverse)
library(janitor) 
library(skimr)
library(countrycode) # to clean up country names
library(broom)
library(car)
library(ggfortify)

```


```{r }

# use googlesheets4 to get data

url <- "https://docs.google.com/spreadsheets/d/1IPS5dBSGtwYVbjsfbaMCYIWnOuRmJcbequohNxCyGVw/edit?resourcekey#gid=1625408792"
googlesheets4::gs4_auth() # google sheets authorisation

# load "Ask a A Manager 2021 Survey" googlesheet
# https://www.askamanager.org/
ask_a_manager_2021 <- googlesheets4::read_sheet(url) %>% 
  janitor::clean_names()

# if googlesheets is now working, read local copy
# ask_a_manager_2021 <- read_csv(here::here("data", "ask_a_manager_2021.csv"))



```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


```{r cars}
clean_data1 <- ask_a_manager_2021%>%
  drop_na(industry)%>%
select(-"additional_context_on_job_title") %>% 
select(-"additional_context_on_income")%>%
select(-"currency_other")%>%
select(-"state")%>%
select(-"city")

clean_data1$other_monetary_comp[is.na(clean_data1$other_monetary_comp)]= 0 
clean_data2 <- clean_data1 %>% 
  mutate(other_monetary_comp = as.numeric(replace(other_monetary_comp, which(other_monetary_comp == "NULL"), 0)))
clean_data3 <- clean_data2 %>% 
  mutate(total_salary = other_monetary_comp + annual_salary)

# exchange different currency to new column, named USD_exchange
## write a function to convert currency 
 currencyCon <- function(x,from = "USD", to = "EUR"){
   values<-c(1.00,0.92,0.81,1.27)
   names(values)<-c("USD","EUR","GBP","CAD")
   values[to]/(values[from]/x)
 }

## apply the function and create a new column
clean_data4 <- clean_data3 %>% 
  mutate(USD_exchange = currencyCon(clean_data3$total_salary, clean_data3$currency, "USD"))

clean_data5 <- clean_data4 %>% 
  mutate(country=countryname(country,'iso3c'))%>%
  drop_na(country) 


```


```{r pressure, echo=FALSE}
clean_data <- clean_data5 %>% 
  filter(gender!="Non-binary")%>%
 filter(gender!="Other or prefer not to answer")%>%
  filter(gender!="Prefer not to answer")
  
mean_clean <- clean_data %>% 
  group_by(gender, industry)%>%
  summarise(mean1=mean(USD_exchange))

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r ppp data}
ppp_data1 <- read_csv(here::here("data","pppdata.csv"))

ppp_data2 <- ppp_data1 %>% 
  filter(TIME == "2020") 

ppp_data3<-ppp_data2[!(ppp_data2$LOCATION=="EU27_2020" | ppp_data2$LOCATION=="EA19"),]
 
```

```{r left join}
ppp_data4 <- ppp_data3 %>% select(LOCATION, Value)
merge_data <- left_join(clean_data, ppp_data4, by = c('country' = 'LOCATION'))

ppp_data<- merge_data %>% 
  mutate(ppp_salary = total_salary / Value) %>% 
filter(!is.na(Value))

ppp_data<- merge_data %>% 
  mutate(ppp_salary = total_salary / Value) %>% 
  filter(!is.na(Value))

```


```{r}
library(stringr)
# 
# filter(ppp_data, str_detect(industry, "Pharmaa*"))
# ppp_data %>% 
#   filter(str_detect(industry,"profa*")) 

# str_view(ppp_data$industry,"^Edua*")

ppp_data5 <- ppp_data %>%
  mutate(
    industry = case_when(
     str_detect(ppp_data$industry, "^Acaa*") ~ "Academia",
     str_detect(ppp_data$industry, "pharmaa*") ~ "Pharmaceuticals",
     str_detect(ppp_data$industry, "Pharmaa*") ~ "Pharmaceuticals",
     str_detect(ppp_data$industry, "^Accounta*") ~ "Accounting, Banking & Finance",
    str_detect(ppp_data$industry, "profa*") ~ "Nonprofits",
    TRUE ~ industry
    )
  )


ppp_data_industry <-  ppp_data5 %>% 
  count(industry,sort=TRUE) %>% 
  mutate(percent=100* n/sum(n)) %>% 
  filter(percent>1)

ppp_industry <- ppp_data_industry$industry

ppp_data_clean <- ppp_data %>% 
  filter(industry %in% ppp_industry)

```




# Plot

To begin with our analysis, we will look at the number of responses with the 

```{r introductory ppp analysis}

ppp_data_clean %>%
  drop_na(industry) %>%
  group_by(industry) %>%
  summarise(Freq = n()) %>%
  ggplot(aes(fct_reorder(industry, Freq),Freq)) +
  geom_bar(stat = "identity", fill = "blue") +
  geom_text(aes(label = Freq), position = position_dodge(width = 1), hjust = -0.2, size = 1.5) +
  coord_flip() +
  xlab("Industry") +
  ylab("Counts") +
  ggtitle("Responses by Industry") +
  theme_bw()

# ggplot(ppp_data_clean, aes(x=ppp_salary))+
# geom_point()
```

```{r}
ppp_data_clean %>% 
  group_by(industry) %>% 
  ggplot(aes(x=ppp_salary,y=industry,color=gender))+
  # facet_wrap(gender~.)+
  geom_point()+
  scale_color_manual(values = c("Man" = "blue", "Woman" = "red"))+
  xlim(0, 500000) 


```

```{r average gender gap}

# Average gender gap in the US by industry

plot1<-ppp_data_clean%>%
  select(gender,industry,ppp_salary,country)%>%
 filter(gender!="Non-binary")%>%
 filter(gender!="Other or prefer not to answer")%>%
 filter(gender!="Prefer not to answer")%>%
 filter(country =="USA")

plot2<-plot1%>%  
 group_by(industry,gender)%>%
 summarise(mean=mean(ppp_salary))

plot1man<-plot2%>% 
  filter(gender =="Man")

plot2woman<-plot2%>%
  filter(gender =="Woman")

plot<-left_join(plot1man,plot2woman,by = "industry")%>%
  mutate(gap=mean.x-mean.y)

plot%>%
  ggplot(aes(x=gap,y=reorder(industry, gap),group=1,fill = gap))+
  geom_bar(stat='identity')+
  labs(title = "Average gender gap in the US by industry",
       subtitle = "Woman / Man",
       x="$",
       y= "industry")+
  theme_bw()
  
```

```{r}
# Average Salary in the US by industry

plot3<-plot1%>%
  select(industry,ppp_salary)%>%
group_by(industry)%>%
summarise(mean1=mean(ppp_salary))
  
  plot3%>%
  ggplot(aes(x=mean1,y=reorder(industry, mean1),group=1,fill = mean1))+
  geom_histogram(stat='identity')+
  labs(title = "Average Salary in the US by industry",
       x="$",
       y= "industry")+
   theme(axis.text=element_text(size=8),
        axis.title=element_text(size=10),
        axis.text.x = element_blank()) +
    theme_bw()
  
```

```{r}
# Average Salary in the US by educational level

plot4<-ppp_data_clean%>%
  drop_na(highest_level_of_education_completed)%>%
  drop_na(USD_exchange)%>%
  select(highest_level_of_education_completed,USD_exchange,country)%>%
  filter(country=="USA")%>%
  group_by(highest_level_of_education_completed)%>%
  summarise(mean2=mean(USD_exchange))

plot4 %>%
  ggplot(aes(x=mean2,y=reorder(highest_level_of_education_completed, mean2),group=1,fill=mean2))+
  geom_bar(stat='identity')+
  labs(title = "Average Salary in the US by educational level",
       x="$",
       y= "educational level")+
   theme(axis.text=element_text(size=8),
        axis.title=element_text(size=10))+
  theme_bw()


```


```{r}

#Average ppp_salary worldwide by industry
library(scales)

plot5<-ppp_data_clean%>%
  select(industry,country,ppp_salary)%>%
  group_by(country,industry)%>% 
  summarise(mean3=mean(ppp_salary))

big_country <- ppp_data_clean %>% 
  count(country, sort = TRUE) %>% 
  mutate(percent = 100*n/sum(n)) %>% 
  filter(percent >0.05)

big_country_list <- big_country$country
plot6 <- plot5 %>% 
  filter(country %in% big_country_list)



# create list of gdp per capita of each country
   values<-c(57447,53265,47607,48137,84987,49548,62709,32026,52131,43959,42915,2338,81315,45958,43597,55606,46278,56763,66678,6441)
   names<-c("AUS","AUT","BEL","CAN","CHE","DEU","DNK","ESP","FIN","FRA","GBR","IND","IRL","ISR","JPN","NLD","NZL","SWE","USA","ZAF")
   
gdp_list <- do.call(rbind, Map(data.frame, A = values, B = names))
colnames(gdp_list) <- c("gdp", "country")

# merge gdp list with origional data
plot7 <- left_join(plot6, gdp_list, by = "country")

# plot with both scatter point and smooth line, x axis is ordered by GDP per capita
plot7%>%
    ggplot(aes(x=reorder(country, gdp),y=mean3,group=1,color=industry))+
  geom_point()+
  geom_smooth(method=lm)+
  scale_y_continuous(labels = dollar)+
  labs(title = "Average ppp_salary distribution by industry and country",
       x="Country",
       y= "Average ppp_salary")+
   theme(axis.text=element_text(size=8),
        axis.title=element_text(size=10))+
  theme_bw()

# plot with only smooth line, x axis is ordered by GDP per capita
plot7%>%
    ggplot(aes(x=reorder(country, gdp),y=mean3,group=1,color=industry))+
  #geom_point()+
  geom_smooth(method = lm)+
  labs(title = "Average ppp_salary distribution by industry and country",
       x="Country",
       y= "Average ppp_salary")+
   theme(axis.text=element_text(size=8),
        axis.title=element_text(size=10))+
  theme_bw()


```


```{r}
ppp_data_clean %>%
  ggplot(aes(x=ppp_salary,y=industry,color=gender))+
  geom_point()+
  scale_color_manual(values = c("Man" = "blue", "Woman" = "red"))+
  xlim(0, 500000)+
  theme_bw()+
  labs(title = "Average ppp_salary distribution by gender and industry",
       x="ppp_salary",
       y= "Industry")


```

# Regression

For our regression analysis, we are predicting the 
```{r Regression}
ppp_data_clean <- ppp_data_clean %>% 
  drop_na(USD_exchange, highest_level_of_education_completed)


ppp_reg <- ppp_data_clean %>% 
  filter(country== "USA")

model1  <- lm(total_salary ~ industry, data=ppp_reg)
mosaic::msummary(model1)

model2  <- lm(total_salary ~ industry + years_of_experience_in_field , data=ppp_reg)
mosaic::msummary(model2)

model3 <- lm(total_salary ~ industry + years_of_experience_in_field + highest_level_of_education_completed, data=ppp_reg)
mosaic::msummary(model3)

model4 <- lm(total_salary ~ industry + years_of_experience_in_field + highest_level_of_education_completed + gender, data=ppp_reg)
mosaic::msummary(model4)

model5 <- lm(total_salary ~ industry + years_of_experience_in_field + highest_level_of_education_completed + gender, data=ppp_reg)
mosaic::msummary(model5)

model6 <- lm(total_salary ~ industry + years_of_experience_in_field + highest_level_of_education_completed + gender+ overall_years_of_professional_experience, data=ppp_reg)
mosaic::msummary(model6)

huxtable::huxreg(model1, model2, model3, model4, model5, model6)


```

